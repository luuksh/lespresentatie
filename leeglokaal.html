<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Klassenplattegrond</title>

  <!-- Styles -->
  <link rel="stylesheet" href="css/style.css?v=20260222-16" />

  <!-- Modules -->
  <script type="module" src="js/indeling.js?v=20260222-16"></script>
  <script type="module" src="js/init.js?v=20260222-16"></script>
</head>
<body>


  <!-- LINKER ZIJPANEEL (hover-to-reveal) -->
  <aside class="side-drawer left" aria-label="Bediening">
    <button class="drawer-handle" aria-label="Open bediening">Bediening</button>
    <div class="drawer-content">
      <!-- Absentie & spiegel -->
      <div class="card control-card">
        <div class="controls-row">
          <button id="save-absenties-btn" type="button" class="btn btn-primary">Opslaan absenties</button>
          <button id="toggle-view-btn" type="button" class="btn btn-secondary">Docentweergave (spiegel)</button>
        </div>
        <div id="save-status" style="margin-top:.6em; font-size:.9em; opacity:.8;"></div>
      </div>

      <!-- Preset controls -->
      <div class="card control-card" style="margin-top:1rem;">
        <div class="toolbar presets-panel">
          <span class="presets-label">Opstelling:</span>
          <select id="presetSelect" class="presets-select"></select>

          <span class="divider"></span>

          <div class="btn-group">
            <button id="btnPresetLoad" class="btn btn-secondary">Laden</button>
            <button id="btnPresetSave" class="btn btn-primary">Opslaan alsâ€¦</button>
            <button id="btnPresetOverwrite" class="btn btn-secondary">Overschrijven</button>
          </div>

          <div class="btn-group">
            <button id="btnPresetRename" class="btn btn-secondary">Hernoemen</button>
            <button id="btnPresetDelete" class="btn btn-danger">Verwijderen</button>
          </div>

          <span class="divider"></span>

          <label for="presetImport" class="btn btn-secondary import-label">Import</label>
          <input id="presetImport" type="file" accept="application/json" hidden />
        </div>
      </div>
    </div>
  </aside>

  <!-- ===== Plattegrondsectie (met dropdowns) in eigen box ===== -->
  <main class="layout">
    <div class="card container">
      <!-- Dropdowns horen nu bij de plattegrondbox -->
      <div class="topbar">
        <div class="controls-row">
          <div class="field">
            <span class="label">Indeling</span>
            <select id="indelingSelect">
              <option value="h216">H216</option>
              <option value="u008">U008</option>
              <option value="groepjes">Viertallen</option>
              <option value="vijftallen">Vijftallen</option>
              <option value="presentatievolgorde">Volgorde</option>
            </select>
          </div>
          <div class="field">
            <span class="label">Klas</span>
            <select id="klasSelect">
              <!-- Wordt automatisch gevuld via JS -->
            </select>
          </div>
        </div>
      </div>

      <div class="grid-wrapper">
        <div class="bureau-rij">
          <div class="leraar-bureau">Bureau leraar</div>
        </div>
        <div class="grid" id="plattegrond">
          <!-- Dynamisch gevuld via JS -->
        </div>
      </div>
    </div>

    <!-- Rechterkolom is leeg; bediening zit links in het zijpaneel -->
    <div></div>
  </main>

  <!-- ====== Scripts die op IDs vertrouwen blijven identiek ====== -->

  <!-- Absentie toggling + reset bij wijzigingen -->
  <script>
    (() => {
      const GRID_ID = 'plattegrond';
      const CARD_SELECTOR = '.tafel, .seat, .student, .desk-item, .naamkaartje, .kaartje, .student-card, .desk';
      const roomSel  = document.getElementById('indelingSelect');
      const classSel = document.getElementById('klasSelect');

      function clearUI() {
        document.querySelectorAll(`#${GRID_ID} ${CARD_SELECTOR}.is-absent`)
          .forEach(el => el.classList.remove('is-absent'));
      }
      function attachDelegatedClick() {
        const grid = document.getElementById(GRID_ID);
        if (!grid) return;
        grid.addEventListener('click', (e) => {
          const card = e.target.closest(CARD_SELECTOR);
          if (!card || !grid.contains(card)) return;
          card.classList.toggle('is-absent');
        });
      }
      function watchGridChanges() {
        const grid = document.getElementById(GRID_ID);
        if (!grid) return;
        const mo = new MutationObserver(() => clearUI());
        mo.observe(grid, { childList: true, subtree: true });
      }
      ['change','click','input'].forEach(evt => {
        roomSel?.addEventListener(evt, () => setTimeout(clearUI, 0));
        classSel?.addEventListener(evt, () => setTimeout(clearUI, 0));
      });
      window.addEventListener('pageshow', () => setTimeout(clearUI, 0));
      const init = () => { attachDelegatedClick(); watchGridChanges(); setTimeout(clearUI, 0); };
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else { init(); }
    })();
  </script>

  <!-- Opslaan absenties in localStorage (daggebonden) -->
  <script>
    (() => {
      const GRID_ID = 'plattegrond';
      const CARD = '.tafel';
      const klasSel = document.getElementById('klasSelect');
      const statusEl = document.getElementById('save-status');
      const key = `absenties_${new Date().toISOString().slice(0,10)}`;

      function nowNL(){
        return new Intl.DateTimeFormat('nl-NL',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(new Date());
      }
      function getAbsentNames(){
        return Array.from(document.querySelectorAll(`#${GRID_ID} ${CARD}.is-absent`))
          .map(el=>el.innerText.trim()).filter(Boolean);
      }
      function saveSnapshot(){
        const klas = klasSel?.value || 'onbekend';
        const names = getAbsentNames();
        let all = [];
        try { all = JSON.parse(localStorage.getItem(key)) || []; } catch {}
        const others = all.filter(e => e && e.klas !== klas);
        if (names.length === 0) {
          localStorage.setItem(key, JSON.stringify(others));
          flash(`Leeg gemaakt voor ${klas} (${nowNL()})`);
          return;
        }
        const entry = { klas, datetime: new Date().toISOString(), names };
        others.push(entry);
        localStorage.setItem(key, JSON.stringify(others));
        flash(`Opgeslagen (${names.length}) voor ${klas} om ${nowNL()}`);
      }
      function flash(msg){
        if(!statusEl) return;
        statusEl.textContent=msg;
        statusEl.style.opacity='1';
        clearTimeout(flash.t);
        flash.t=setTimeout(()=>{statusEl.style.opacity='0';},2500);
      }
      document.getElementById('save-absenties-btn')?.addEventListener('click', saveSnapshot);
    })();
  </script>

  <!-- Spiegelweergave toggle -->
  <script>
    (() => {
      const container = document.querySelector('.container');
      const btn = document.getElementById('toggle-view-btn');
      const LS_KEY = 'mirror_view_enabled';
      const indelingSel = document.getElementById('indelingSelect');
      const klasSel     = document.getElementById('klasSelect');

      function setMirror(on){
        container.classList.toggle('mirror', on);
        try { localStorage.setItem(LS_KEY, on ? '1' : '0'); } catch {}
        if (btn) btn.textContent = on ? 'Leerlingenweergave' : 'Docentweergave (spiegel)';
      }
      function applyFromStorage(){ setMirror(localStorage.getItem(LS_KEY) === '1'); }
      function toggleMirror(){ setMirror(!container.classList.contains('mirror')); }

      btn?.addEventListener('click', toggleMirror);
      indelingSel?.addEventListener('change', () => setMirror(false));
      klasSel?.addEventListener('change',     () => setMirror(false));

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applyFromStorage);
      } else { applyFromStorage(); }
    })();
  </script>

  <!-- Preset UI hookup -->
  <script type="module">
    import { initPresetUI } from './js/seating-presets.js';

    const getCurrentClassId = () =>
      document.getElementById('klasSelect')?.value || 'onbekend';

    function getCurrentArrangement() {
      const seats = Array.from(document.querySelectorAll('#plattegrond .tafel'));
      return seats.map((el, i) => ({
        seatId: el.dataset.seatId ?? String(i),
        studentId: (el.textContent || '').trim()
      }));
    }

    function applyArrangement(arr) {
      const seats = Array.from(document.querySelectorAll('#plattegrond .tafel'));
      const byId = new Map(seats.map((el, i) => [el.dataset.seatId ?? `__idx_${i}`, el]));
      arr.forEach((item, i) => {
        const key = (item.seatId != null && byId.has(String(item.seatId)))
          ? String(item.seatId) : `__idx_${i}`;
        const el = byId.get(key);
        if (el) el.textContent = item.studentId || '';
      });
    }

    const presetUI = initPresetUI({ getCurrentClassId, getCurrentArrangement, applyArrangement });
    document.getElementById('klasSelect')?.addEventListener('change', () => {
      presetUI.refreshForClassChange();
    });
  </script>

</body>
</html>
