<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Klassenplattegrond</title>

  <!-- Styles -->
  <link rel="stylesheet" href="css/style.css" />

  <!-- App init (bestaande logica) -->
  <script type="module" src="js/init.js"></script>
</head>
<body>

  <!-- Topbalk: dropdowns links + opdrachtenbalk rechts -->
  <div class="topbar">
    <div class="indeling-knop">
      <select id="indelingSelect">
        <option value="h216">H216</option>
        <option value="u008">U008</option>
        <option value="groepjes">Viertallen</option>
      </select>

      <select id="klasSelect">
        <!-- Wordt automatisch gevuld via JS -->
      </select>
    </div>

    <!-- Opdrachtenbalk (mooi paneel, geen knop-look) -->
    <div class="opdracht-balk is-success">
      <div class="opdracht-tekst">
        <strong>Lees in je leesboek.</strong>
      </div>
    </div>
  </div>

  <!-- Hoofdcontainer met plattegrond en leraarsbureau -->
  <div class="container">
    <div class="grid-wrapper">
      <div class="bureau-rij">
        <div class="leraar-bureau">Bureau leraar</div>
      </div>
      <div class="grid" id="plattegrond">
        <!-- Hier komen de tafels/groepjes dynamisch via JS -->
      </div>
    </div>
  </div>
<script>
(() => {
  // === Instellingen ===
  const GRID_ID = 'plattegrond';
  // Pas dit aan als jouw kaartjes andere klassennamen hebben:
  const CARD_SELECTOR = '.seat, .student, .desk-item, .naamkaartje, .kaartje, .student-card, .desk';

  // Jouw dropdowns:
  const roomSel  = document.getElementById('indelingSelect');
  const classSel = document.getElementById('klasSelect');

  const keyForStorage = () => {
    const r = roomSel?.value || 'room';
    const c = classSel?.value || 'class';
    return `absent_${r}_${c}`;
  };

  // Toggle met event delegation (werkt ook voor later ingevoegde elementen)
  function attachDelegatedClick() {
    const grid = document.getElementById(GRID_ID);
    if (!grid) return;
    grid.addEventListener('click', (e) => {
      const card = e.target.closest(CARD_SELECTOR);
      if (!card || !grid.contains(card)) return;
      card.classList.toggle('is-absent');
      persist();
    });
  }

  // Opslaan & herstellen
  function persist() {
    const cards = Array.from(document.querySelectorAll(`#${GRID_ID} ${CARD_SELECTOR}`));
    const idxs = cards
      .map((el, i) => el.classList.contains('is-absent') ? i : null)
      .filter(i => i !== null);
    try { localStorage.setItem(keyForStorage(), JSON.stringify(idxs)); } catch {}
  }

  function restore() {
    const raw = localStorage.getItem(keyForStorage());
    const idxs = raw ? (JSON.parse(raw) || []) : [];
    const cards = Array.from(document.querySelectorAll(`#${GRID_ID} ${CARD_SELECTOR}`));
    cards.forEach((el, i) => el.classList.toggle('is-absent', idxs.includes(i)));
  }

  // Als de grid-inhoud wijzigt (init.js rendert): opnieuw herstellen
  function watchGridChanges() {
    const grid = document.getElementById(GRID_ID);
    if (!grid) return;
    const mo = new MutationObserver(() => restore());
    mo.observe(grid, { childList: true, subtree: true });
  }

  // Wissel lokaal/klas => andere set
  roomSel?.addEventListener('change', restore);
  classSel?.addEventListener('change', restore);

  // Init
  const init = () => {
    attachDelegatedClick();
    watchGridChanges();
    // kleine delay voor eerste render door init.js, daarna herstellen
    setTimeout(restore, 0);
  };
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else { init(); }
})();
</script>

</body>
</html>
