<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Klassenplattegrond</title>

  <!-- Styles -->
  <link rel="stylesheet" href="css/style.css" />

  <!-- App init (bestaande logica) -->
  <script type="module" src="js/init.js"></script>
</head>
<body>

  <!-- Topbalk: dropdowns links + opdrachtenbalk rechts -->
  <div class="topbar">
    <div class="indeling-knop">
      <select id="indelingSelect">
        <option value="h216">H216</option>
        <option value="u008">U008</option>
        <option value="groepjes">Viertallen</option>
      </select>

      <select id="klasSelect">
        <!-- Wordt automatisch gevuld via JS -->
      </select>
    </div>

    <!-- Opdrachtenbalk (mooi paneel, geen knop-look) -->
    <div class="opdracht-balk is-success">
      <div class="opdracht-tekst">
        <strong>Lees in je leesboek.</strong>
      </div>
    </div>
  </div>

  <!-- Hoofdcontainer met plattegrond en leraarsbureau -->
  <div class="container">
    <div class="grid-wrapper">
      <div class="bureau-rij">
        <div class="leraar-bureau">Bureau leraar</div>
      </div>
      <div class="grid" id="plattegrond">
        <!-- Hier komen de tafels/groepjes dynamisch via JS -->
      </div>
    </div>
  </div>
      <div style="margin-top:1.5em; text-align:center;">
  <button id="save-absenties-btn" type="button" class="btn-primary">Opslaan absenties</button>
  <div id="save-status" style="margin-top:.6em; font-size:.9em; opacity:.8;"></div>
</div>

<script>
(() => {
  const GRID_ID = 'plattegrond';

  // Belangrijk: voeg .tafel toe (dat is jouw echte kaartje)
  const CARD_SELECTOR =
    '.tafel, .seat, .student, .desk-item, .naamkaartje, .kaartje, .student-card, .desk';

  const roomSel  = document.getElementById('indelingSelect');
  const classSel = document.getElementById('klasSelect');

  const keyForStorage = () => {
    const r = roomSel?.value || 'room';
    const c = classSel?.value || 'class';
    return `absent_${r}_${c}`;
  };

  // Event delegation: klik op elk toekomstig kaartje
  function attachDelegatedClick() {
    const grid = document.getElementById(GRID_ID);
    if (!grid) return;
    grid.addEventListener('click', (e) => {
      const card = e.target.closest(CARD_SELECTOR);
      if (!card || !grid.contains(card)) return;
      card.classList.toggle('is-absent');
      persist();
    });
  }

  function persist() {
    const cards = Array.from(document.querySelectorAll(`#${GRID_ID} ${CARD_SELECTOR}`));
    const idxs = cards.map((el, i) => el.classList.contains('is-absent') ? i : null)
                      .filter(i => i !== null);
    try { localStorage.setItem(keyForStorage(), JSON.stringify(idxs)); } catch {}
  }

  function restore() {
    const raw = localStorage.getItem(keyForStorage());
    const idxs = raw ? (JSON.parse(raw) || []) : [];
    const cards = Array.from(document.querySelectorAll(`#${GRID_ID} ${CARD_SELECTOR}`));
    cards.forEach((el, i) => el.classList.toggle('is-absent', idxs.includes(i)));
  }

  function watchGridChanges() {
    const grid = document.getElementById(GRID_ID);
    if (!grid) return;
    const mo = new MutationObserver(() => restore());
    mo.observe(grid, { childList: true, subtree: true });
  }

  roomSel?.addEventListener('change', restore);
  classSel?.addEventListener('change', restore);

  const init = () => {
    attachDelegatedClick();
    watchGridChanges();
    setTimeout(restore, 0);
  };
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else { init(); }
})();
</script>
<script>
(() => {
  const GRID_ID = 'plattegrond';
  const CARD = '.tafel';
  const klasSel = document.getElementById('klasSelect');
  const statusEl = document.getElementById('save-status');
  const key = "absenties_dag"; // centrale opslag voor de dag

  function nowNL(){
    return new Intl.DateTimeFormat('nl-NL',{
      year:'numeric',month:'2-digit',day:'2-digit',
      hour:'2-digit',minute:'2-digit'
    }).format(new Date());
  }

  function getAbsentNames(){
    return Array.from(document.querySelectorAll(`#${GRID_ID} ${CARD}.is-absent`))
      .map(el=>el.innerText.trim()).filter(Boolean);
  }

  function saveSnapshot(){
    const klas = klasSel?.value || 'onbekend';
    const names = getAbsentNames();
    const entry = { klas, datetime:new Date().toISOString(), names };
    let all=[];
    try{ all=JSON.parse(localStorage.getItem(key))||[]; }catch{}
    all.push(entry);
    localStorage.setItem(key, JSON.stringify(all));
    flash(`Opgeslagen (${names.length}) voor ${klas} om ${nowNL()}`);
  }

  function flash(msg){
    if(!statusEl) return;
    statusEl.textContent=msg;
    statusEl.style.opacity='1';
    clearTimeout(flash.t);
    flash.t=setTimeout(()=>{statusEl.style.opacity='0';},2500);
  }

  document.getElementById('save-absenties-btn')
    ?.addEventListener('click', saveSnapshot);
})();
</script>

  
</body>
</html>
