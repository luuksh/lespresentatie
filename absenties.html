<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Dagoverzicht absenties</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    body { font-family: Segoe UI, sans-serif; padding:2em; }
    h3 { margin-top:0; }
    .btn-primary, .btn-secondary { margin-right:.5em; margin-top:.3em; }
    .klas-block { margin-bottom:1.5em; }
    pre { background:#f5f5f5; padding:.5em; border-radius:6px; }
  </style>
</head>
<body>
  <h3>Dagoverzicht absenties</h3>
  <div id="absentie-lijst"></div>
  <button id="clear-day-btn" class="btn-secondary">Wis dagoverzicht</button>

 <script>
(() => {
  const listEl = document.getElementById('absentie-lijst');
  const clearBtn = document.getElementById('clear-day-btn');

  // (optioneel) maak een <input type="date" id="day"> boven je lijst
  let dayInput = document.getElementById('day');
  if (!dayInput) {
    dayInput = document.createElement('input');
    dayInput.type = 'date';
    dayInput.id = 'day';
    dayInput.style.margin = '0 0 1em 0';
    document.body.insertBefore(dayInput, listEl);
  }
  const todayStr = new Date().toISOString().slice(0,10);
  if (!dayInput.value) dayInput.value = todayStr;

  const legacyKey = 'absenties_dag';
  const keyFor = (dateStr) => `absenties_${dateStr}`;

  function readStorage(dateStr){
    // probeer nieuwe sleutel, val anders terug op legacy
    let data = [];
    const k = keyFor(dateStr);
    try { data = JSON.parse(localStorage.getItem(k) || '[]'); } catch {}
    if (!data.length && dateStr === todayStr) {
      // fallback voor oude builds
      try { data = JSON.parse(localStorage.getItem(legacyKey) || '[]'); } catch {}
    }
    return data;
  }

  function render(){
    const dateStr = dayInput.value || todayStr;
    const all = readStorage(dateStr);

    if (!all.length) {
      listEl.innerHTML = `<em>Geen absenties opgeslagen voor ${dateStr}.</em>`;
      return;
    }

    // groepeer per klas met unieke namen
    const byClass = {};
    all.forEach(e => {
      if (!byClass[e.klas]) byClass[e.klas] = new Set();
      (e.names || []).forEach(n => byClass[e.klas].add(n));
    });

    let html = '';
    Object.keys(byClass).sort().forEach(klas => {
      const arr = [...byClass[klas]];
      html += `
        <div class="klas-block">
          <h4>${klas}</h4>
          <pre>${arr.join('\n') || '— geen —'}</pre>
          <button class="btn-primary copy-btn" data-klas="${klas}">Kopieer ${klas}</button>
        </div>
      `;
    });
    html += `<button id="copy-all-btn" class="btn-primary">Kopieer alles</button>`;
    listEl.innerHTML = html;

    // events
    listEl.querySelectorAll('.copy-btn').forEach(btn => {
      btn.addEventListener('click', () => copyClass(btn.dataset.klas));
    });
    document.getElementById('copy-all-btn')?.addEventListener('click', copyAll);
  }

  function copyClass(klas){
    const dateStr = dayInput.value || todayStr;
    const all = readStorage(dateStr);
    const names = [...new Set(all.filter(e => e.klas === klas).flatMap(e => e.names || []))];
    navigator.clipboard.writeText(names.join('\n'));
    alert(`Afwezigen ${klas} gekopieerd (${names.length}).`);
  }

  function copyAll(){
    const dateStr = dayInput.value || todayStr;
    const all = readStorage(dateStr);
    const byClass = {};
    all.forEach(e => {
      if (!byClass[e.klas]) byClass[e.klas] = new Set();
      (e.names || []).forEach(n => byClass[e.klas].add(n));
    });
    let text = '';
    Object.keys(byClass).sort().forEach(klas => {
      text += `${klas}:\n${[...byClass[klas]].join('\n')}\n\n`;
    });
    navigator.clipboard.writeText(text.trim());
    alert('Alle absenties gekopieerd.');
  }

  clearBtn?.addEventListener('click', () => {
    const dateStr = dayInput.value || todayStr;
    localStorage.removeItem(keyFor(dateStr));
    // ook legacy wissen als je op vandaag staat
    if (dateStr === todayStr) localStorage.removeItem('absenties_dag');
    render();
  });

  dayInput.addEventListener('change', render);
  render();
})();
</script>

</body>
</html>
