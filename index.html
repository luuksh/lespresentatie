<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Klassenplattegrond</title>

  <link rel="stylesheet" href="css/style.css" />

  <script type="module" src="js/indeling.js"></script>
  <script type="module" src="js/init.js"></script>
</head>
<body>
  <header class="app-header">
    <div>
      <p class="eyebrow">Lespresentatie</p>
      <h1>Klassenplattegrond</h1>
      <p class="subtitle">Visuele, snelle en betrouwbare indeling voor in de klas.</p>
    </div>
    <div class="header-actions">
      <div class="header-pill">Klik op een leerling om afwezig te markeren</div>
      <button id="btnShowcaseMode" type="button" class="btn btn-secondary">Showcase-modus</button>
      <button id="btnPrintLayout" type="button" class="btn btn-secondary">Print / PDF</button>
    </div>
  </header>

  <div id="opdrachtMount" class="floating-card opdracht-card">
    <iframe src="opdracht.html" title="Lesopdracht" id="opdrachtFrame"></iframe>
  </div>

  <aside class="side-drawer left" aria-label="Bediening">
    <button class="drawer-handle" aria-label="Open bediening">Bediening</button>
    <div class="drawer-content">
      <section class="card control-card">
        <h2 class="panel-title">Sessie</h2>
        <div class="controls-row">
          <button id="save-absenties-btn" type="button" class="btn btn-primary">Opslaan absenties</button>
          <button id="toggle-view-btn" type="button" class="btn btn-secondary">Docentweergave (spiegel)</button>
          <button id="btnShowcaseModeDrawer" type="button" class="btn btn-secondary">Showcase-modus</button>
          <button id="btnPrintLayoutDrawer" type="button" class="btn btn-secondary">Print / PDF</button>
        </div>
        <div id="save-status" class="status-text"></div>
      </section>

      <section class="card control-card">
        <h2 class="panel-title">Opstellingen</h2>

        <div class="toolbar presets-panel">
          <span class="presets-label">Preset</span>
          <select id="presetSelect" class="presets-select"></select>

          <div class="btn-group">
            <button id="btnPresetLoad" class="btn btn-secondary">Laden</button>
            <button id="btnPresetSave" class="btn btn-primary">Opslaan als…</button>
            <button id="btnPresetOverwrite" class="btn btn-secondary">Overschrijven</button>
          </div>

          <div class="btn-group">
            <button id="btnPresetRename" class="btn btn-secondary">Hernoemen</button>
            <button id="btnPresetDelete" class="btn btn-danger">Verwijderen</button>
          </div>

          <div class="btn-group">
            <button id="btnPresetExport" class="btn btn-secondary">Export .doc</button>
            <label for="presetImport" class="btn btn-secondary import-label">Import JSON</label>
          </div>

          <input id="presetImport" type="file" accept="application/json" hidden />
        </div>
      </section>
    </div>
  </aside>

  <main class="layout">
    <section class="plattegrond-frame">
      <div class="print-meta" id="printMeta"></div>
      <div class="topbar">
        <div class="controls-row">
          <div class="field">
            <span class="label">Indeling</span>
            <select id="indelingSelect">
              <option value="h216">H216</option>
              <option value="u008">U008</option>
              <option value="drietallen">Drietallen</option>
              <option value="groepjes">Viertallen</option>
              <option value="vijftallen">Vijftallen</option>
              <option value="presentatievolgorde">Volgorde</option>
            </select>
          </div>

          <div class="field">
            <span class="label">Klas</span>
            <select id="klasSelect"></select>
          </div>
        </div>
      </div>

      <div class="grid-wrapper">
        <div class="bureau-rij">
          <div class="leraar-bureau">Bureau leraar</div>
        </div>
        <div class="grid" id="plattegrond"></div>
      </div>
    </section>
  </main>

  <div id="timerDock" class="floating-card timer-card">
    <iframe src="timer.html" title="Timer" id="timerFrame"></iframe>
  </div>

  <div id="showcaseHint" class="showcase-hint" aria-live="polite">Showcase-modus actief · druk op Esc om terug te gaan</div>

  <script>
    (() => {
      const GRID_ID = 'plattegrond';
      const CARD_SELECTOR = '.tafel, .seat, .student, .desk-item, .naamkaartje, .kaartje, .student-card, .desk';
      const roomSel  = document.getElementById('indelingSelect');
      const classSel = document.getElementById('klasSelect');

      function clearUI() {
        document.querySelectorAll(`#${GRID_ID} ${CARD_SELECTOR}.is-absent`)
          .forEach(el => el.classList.remove('is-absent'));
      }
      function attachDelegatedClick() {
        const grid = document.getElementById(GRID_ID);
        if (!grid) return;
        grid.addEventListener('click', (e) => {
          const card = e.target.closest(CARD_SELECTOR);
          if (!card || !grid.contains(card)) return;
          card.classList.toggle('is-absent');
        });
      }
      function watchGridChanges() {
        const grid = document.getElementById(GRID_ID);
        if (!grid) return;
        const mo = new MutationObserver(() => clearUI());
        mo.observe(grid, { childList: true, subtree: true });
      }
      ['change','click','input'].forEach(evt => {
        roomSel?.addEventListener(evt, () => setTimeout(clearUI, 0));
        classSel?.addEventListener(evt, () => setTimeout(clearUI, 0));
      });
      window.addEventListener('pageshow', () => setTimeout(clearUI, 0));
      const init = () => { attachDelegatedClick(); watchGridChanges(); setTimeout(clearUI, 0); };
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else { init(); }
    })();
  </script>

  <script>
    (() => {
      const GRID_ID = 'plattegrond';
      const CARD = '.tafel';
      const klasSel = document.getElementById('klasSelect');
      const statusEl = document.getElementById('save-status');
      const key = `absenties_${new Date().toISOString().slice(0,10)}`;

      function nowNL(){
        return new Intl.DateTimeFormat('nl-NL',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(new Date());
      }
      function getAbsentNames(){
        return Array.from(document.querySelectorAll(`#${GRID_ID} ${CARD}.is-absent`))
          .map(el=>el.innerText.trim()).filter(Boolean);
      }
      function saveSnapshot(){
        const klas = klasSel?.value || 'onbekend';
        const names = getAbsentNames();
        let all = [];
        try { all = JSON.parse(localStorage.getItem(key)) || []; } catch {}
        const others = all.filter(e => e && e.klas !== klas);
        if (names.length === 0) {
          localStorage.setItem(key, JSON.stringify(others));
          flash(`Leeg gemaakt voor ${klas} (${nowNL()})`);
          return;
        }
        const entry = { klas, datetime: new Date().toISOString(), names };
        others.push(entry);
        localStorage.setItem(key, JSON.stringify(others));
        flash(`Opgeslagen (${names.length}) voor ${klas} om ${nowNL()}`);
      }
      function flash(msg){
        if(!statusEl) return;
        statusEl.textContent = msg;
        statusEl.style.opacity = '1';
        clearTimeout(flash.t);
        flash.t = setTimeout(() => { statusEl.style.opacity = '0'; }, 2800);
      }
      document.getElementById('save-absenties-btn')?.addEventListener('click', saveSnapshot);
    })();
  </script>

  <script>
    (() => {
      const container = document.querySelector('.plattegrond-frame');
      const btn = document.getElementById('toggle-view-btn');
      const LS_KEY = 'mirror_view_enabled';
      const indelingSel = document.getElementById('indelingSelect');
      const klasSel     = document.getElementById('klasSelect');

      function setMirror(on){
        container?.classList.toggle('mirror', on);
        try { localStorage.setItem(LS_KEY, on ? '1' : '0'); } catch {}
        if (btn) btn.textContent = on ? 'Leerlingenweergave' : 'Docentweergave (spiegel)';
      }
      function applyFromStorage(){ setMirror(localStorage.getItem(LS_KEY) === '1'); }
      function toggleMirror(){ setMirror(!container?.classList.contains('mirror')); }

      btn?.addEventListener('click', toggleMirror);
      indelingSel?.addEventListener('change', () => setMirror(false));
      klasSel?.addEventListener('change', () => setMirror(false));

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applyFromStorage);
      } else { applyFromStorage(); }
    })();
  </script>

  <script>
    (() => {
      const btnHeaderShowcase = document.getElementById('btnShowcaseMode');
      const btnDrawerShowcase = document.getElementById('btnShowcaseModeDrawer');
      const btnHeaderPrint = document.getElementById('btnPrintLayout');
      const btnDrawerPrint = document.getElementById('btnPrintLayoutDrawer');
      const hint = document.getElementById('showcaseHint');
      const body = document.body;
      const indelingSel = document.getElementById('indelingSelect');
      const klasSel = document.getElementById('klasSelect');
      const printMeta = document.getElementById('printMeta');

      function nowNL() {
        return new Intl.DateTimeFormat('nl-NL', {
          year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
        }).format(new Date());
      }

      function updatePrintMeta() {
        const indeling = indelingSel?.selectedOptions?.[0]?.textContent?.trim() || 'Onbekende indeling';
        const klas = klasSel?.selectedOptions?.[0]?.textContent?.trim() || 'Onbekende klas';
        printMeta.textContent = `Klassenplattegrond · ${klas} · ${indeling} · ${nowNL()}`;
      }

      async function enterFullscreen() {
        if (document.fullscreenElement) return;
        try { await document.documentElement.requestFullscreen(); } catch {}
      }

      async function exitFullscreen() {
        if (!document.fullscreenElement) return;
        try { await document.exitFullscreen(); } catch {}
      }

      async function setShowcase(on) {
        body.classList.toggle('showcase-mode', on);
        hint?.classList.toggle('visible', on);

        const label = on ? 'Showcase uit' : 'Showcase-modus';
        if (btnHeaderShowcase) btnHeaderShowcase.textContent = label;
        if (btnDrawerShowcase) btnDrawerShowcase.textContent = label;

        if (on) {
          updatePrintMeta();
          await enterFullscreen();
        } else {
          await exitFullscreen();
        }
      }

      function toggleShowcase() {
        const on = !body.classList.contains('showcase-mode');
        setShowcase(on);
      }

      function runPrint() {
        updatePrintMeta();
        window.print();
      }

      btnHeaderShowcase?.addEventListener('click', toggleShowcase);
      btnDrawerShowcase?.addEventListener('click', toggleShowcase);
      btnHeaderPrint?.addEventListener('click', runPrint);
      btnDrawerPrint?.addEventListener('click', runPrint);

      indelingSel?.addEventListener('change', updatePrintMeta);
      klasSel?.addEventListener('change', updatePrintMeta);

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && body.classList.contains('showcase-mode')) {
          setShowcase(false);
        }
      });

      document.addEventListener('fullscreenchange', () => {
        if (!document.fullscreenElement && body.classList.contains('showcase-mode')) {
          body.classList.remove('showcase-mode');
          hint?.classList.remove('visible');
          if (btnHeaderShowcase) btnHeaderShowcase.textContent = 'Showcase-modus';
          if (btnDrawerShowcase) btnDrawerShowcase.textContent = 'Showcase-modus';
        }
      });

      updatePrintMeta();
    })();
  </script>

  <script>
    function autosizeIframe(iframe){
      try{
        const doc = iframe.contentDocument || iframe.contentWindow.document;
        if(!doc) return;

        const getH = () => {
          const b = doc.body, e = doc.documentElement;
          return Math.max(b.scrollHeight, b.offsetHeight, e.clientHeight, e.scrollHeight, e.offsetHeight);
        };
        const getW = () => {
          const b = doc.body, e = doc.documentElement;
          const contentW = Math.max(b.scrollWidth, e.scrollWidth, b.offsetWidth, e.offsetWidth);
          const viewportCap = Math.floor(window.innerWidth * 0.98);
          return Math.min(contentW, viewportCap);
        };

        const set = () => {
          iframe.style.height = getH() + 'px';
          iframe.style.width  = getW() + 'px';
        };

        set();
        const ro = new ResizeObserver(set); ro.observe(doc.documentElement);
        const mo = new MutationObserver(set); mo.observe(doc, {childList:true, subtree:true, attributes:true, characterData:true});
        window.addEventListener('resize', set);
        iframe._cleanup = () => { ro.disconnect(); mo.disconnect(); window.removeEventListener('resize', set); };
      } catch(e){
        // same-origin vereist; anders geen autosize mogelijk
      }
    }

    window.addEventListener('load', () => {
      autosizeIframe(document.getElementById('opdrachtFrame'));
      autosizeIframe(document.getElementById('timerFrame'));
    });
  </script>
</body>
</html>
